<!DOCTYPE html>
<html lang="{{ lang }}">
<head>
    <meta charset="UTF-8">
    <title>{{ get_text(lang, 'title') }}</title>
    <link href="https://unpkg.com/tabulator-tables@5.6.1/dist/css/tabulator_modern.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    
    <aside class="sidebar">
        <div class="lang-selector">
            <button id="btn-lang-es" class="lang-button {% if lang == 'es' %}active{% endif %}" data-lang="es">Español</button>
            <button id="btn-lang-en" class="lang-button {% if lang == 'en' %}active{% endif %}" data-lang="en">English</button>
        </div>

        <h2>{{ get_text(lang, 'control_area') }}</h2>
        
        <h3>1. {{ get_text(lang, 'uploader_label') }}</h3>
        <div class="file-uploader-container">
            <label class="drag-drop-label" for="file-uploader">
                <div class="drag-drop-area">
                    <p>Drag and drop files here</p>
                    <span>Limit 200MB per file • XLSX</span>
                    <span class="btn-browse">Browse files</span>
                </div>
            </label>
            <input type="file" id="file-uploader" accept=".xlsx" multiple style="display: none;">
            <div id="file-upload-list"></div>
        </div>
        
        <h3>2. {{ get_text(lang, 'add_filter_header') }}</h3>
        <div style="display: flex; flex-direction: column; gap: 8px;">
            <select id="select-columna">
                <option value="">{{ get_text(lang, 'column_select') }}</option>
            </select>
            
            <input type="text" id="input-valor" placeholder="{{ get_text(lang, 'search_text') }}" list="input-valor-list">
            <datalist id="input-valor-list"></datalist>
            
            <button id="btn-add-filter">{{ get_text(lang, 'add_filter_button') }}</button>
        </div>
        
        <h3>3. {{ get_text(lang, 'visible_columns_header') }}</h3>
        <div class="column-toggle-buttons">
            <button id="btn-check-all-cols" class="btn-small-link">{{ get_text(lang, 'check_all_button') }}</button>
            <button id="btn-uncheck-all-cols" class="btn-small-link">{{ get_text(lang, 'uncheck_all_button') }}</button>
        </div>
        <div id="column-selector-wrapper">
          <p>{{ get_text(lang, 'info_upload') }}</p> 
        </div>

        <h3 style="margin-top: 1.5rem;">4. {{ get_text(lang, 'manage_lists_header') }}</h3>
        <button id="btn-manage-lists" class="btn-small-link" style="width: 100%;">
            {{ get_text(lang, 'manage_lists_button') }}
        </button>
        
        <h3 style="margin-top: 1.5rem;">5. Guardar/Cargar Vista</h3>
        <div class="column-toggle-buttons">
            <button id="btn-save-view" class="btn-small-link" style="width: 100%;">
                <i class="fas fa-save" style="margin-right: 8px;"></i> Guardar Vista Actual (.json)
            </button>
            
            <label for="input-load-view" class="btn-small-link" style="width: 100%; text-align: center; cursor: pointer; margin-bottom: 0;">
                <i class="fas fa-folder-open" style="margin-right: 8px;"></i> Cargar Vista (.json)
            </label>
            <input type="file" id="input-load-view" accept=".json" style="display: none;">
        </div>

        <h3 style="margin-top: 1.5rem;">6. Reglas de Prioridad</h3>
        <button id="btn-priority-rules" class="btn-small-link" style="width: 100%;">
            <i class="fas fa-tasks" style="margin-right: 8px;"></i> Configurar Reglas
        </button>

        <h3 style="margin-top: 1.5rem;">7. {{ get_text(lang, 'data_cleaning_header') }}</h3>
        <p class="sidebar-description">
            {{ get_text(lang, 'data_cleaning_desc') }}
        </p>
        <button id="btn-show-duplicates" class="btn-small-link" style="width: 100%;">
            <i class="fas fa-eye" style="margin-right: 8px;"></i> {{ get_text(lang, 'btn_show_duplicates') }}
        </button>
        <button id="btn-cleanup-duplicates" class="btn-rojo-secundario" style="width: 100%; margin-top: 8px;">
            <i class="fas fa-magic" style="margin-right: 8px;"></i> {{ get_text(lang, 'btn_cleanup_duplicates') }}
        </button>
        
    </aside>

    <main class="content">

        <div class="content-header-sutil">
            <h1>{{ get_text(lang, 'title') }}</h1>
            <span>{{ get_text(lang, 'subtitle') }}</span>
        </div>
        
        <div class="resumen-busqueda" id="resumen-busqueda-kpis">
            <div class="resumen-card-item card-blue">
                <div class="card-icon">
                    <i class="fas fa-file-invoice"></i>
                </div>
                <div class="card-data">
                    <span class="card-titulo">{{ get_text(lang, 'summary_total_invoices') }}</span>
                    <span class="card-valor" id="resumen-total-facturas">0</span>
                </div>
            </div>

            <div class="resumen-card-item card-green">
                <div class="card-icon">
                    <i class="fas fa-dollar-sign"></i>
                </div>
                <div class="card-data">
                    <span class="card-titulo">{{ get_text(lang, 'summary_total_amount') }}</span>
                    <span class="card-valor" id="resumen-monto-total">$0.00</span>
                </div>
            </div>

            <div class="resumen-card-item card-purple">
                <div class="card-icon">
                    <i class="fas fa-chart-pie"></i>
                </div>
                <div class="card-data">
                    <span class="card-titulo">{{ get_text(lang, 'summary_avg_amount') }}</span>
                    <span class="card-valor" id="resumen-monto-promedio">$0.00</span>
                </div>
            </div>
        </div>
        <div class="view-selector-container">
            <div class="view-selector-sub-container">
                <span class="view-selector-label">{{ get_text(lang, 'view_type_header') }}:</span>
                <div class="view-selector-buttons">
                    <button id="btn-view-detailed" class="view-button active">{{ get_text(lang, 'view_type_detailed') }}</button>
                    <button id="btn-view-grouped" class="view-button">{{ get_text(lang, 'view_type_grouped') }}</button>
                </div>
            </div>
            <div class="group-by-wrapper" id="group-by-controls-wrapper" style="display: none;">
                <label for="select-columna-agrupar">{{ get_text(lang, 'group_by_select') }}</label>
                <select id="select-columna-agrupar">
                    <option value="">{{ get_text(lang, 'group_by_placeholder') }}</option>
                    </select>
            </div>
        </div>

        <div id="view-container-detailed" class="content-card" style="display: flex; flex-direction: column;">
            
            <div class="table-controls">
                <div id="active-filters-list" style="flex-grow: 1; display: flex; flex-wrap: wrap; gap: 0.5rem;">
                    </div>
                
                <button id="btn-bulk-edit-filtered" class="btn-azul-secundario" onclick="openBulkEditModal('filter')" style="display: inline-block;" title="Editar todas las filas que coinciden con los filtros actuales">
                    <i class="fas fa-edit"></i> Editar Filas Filtradas
                </button>

                <button id="btn-bulk-edit" class="btn-azul-secundario" style="display: none;" title="Edita todas las filas seleccionadas a la vez">
                    {{ get_text(lang, 'btn_bulk_edit') }}
                </button>

                <button id="btn-bulk-delete" class="btn-rojo-secundario" style="display: none;" title="Elimina todas las filas seleccionadas de la tabla">
                    {{ get_text(lang, 'btn_bulk_delete') }}
                </button>
                
                <button id="btn-find-replace" class="btn-azul-secundario" style="display: none;" title="Buscar y Reemplazar en selección">
                   {{ get_text(lang, 'btn_find_replace') }}
                </button>

                <button id="btn-add-row" class="btn-verde-secundario" style="display: none;" title="Añade una nueva fila en blanco al final (Hotkey: A)">
                    Añadir Fila
                </button>
                
                <button id="btn-commit-changes" class="btn-verde-secundario" style="display: none;" title="Guarda todos los cambios como 'estables' y limpia el historial de deshacer (Hotkey: S)">
                    Consolidar Cambios
                </button>

                <button id="btn-download-audit-log" class="btn-azul-secundario" style="display: none;" title="Descarga el reporte de auditoría de todos los cambios de la sesión (TXT)">
                    <i class="fas fa-clipboard-list" style="margin-right: 5px;"></i> Reporte
                </button>
                
                <button id="btn-undo-change" class="btn-rojo-secundario" style="display: none;" title="Deshace la última edición de celda (Hotkey: Z)">
                    {{ get_text(lang, 'btn_undo') }}
                </button>
                
                <button id="btn-clear-filters" class="btn-rojo-secundario" style="display: none;" title="(Hotkey: Delete)">{{ get_text(lang, 'clear_all_button') }}</button>
                
                <div class="search-wrapper">
                    <input type="text" id="input-search-table" placeholder="{{ get_text(lang, 'search_text') }}... (Hotkey: F)">
                    <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                </div>
            </div>
            <div style="position: relative; flex-grow: 1; min-height: 0;">
                <div class="table-actions">
                    <button id="btn-fullscreen" class="icon-button" title="Pantalla Completa (Hotkey: G)">
                       <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3.75v4.5m0-4.5h4.5m-4.5 0L9 9M3.75 20.25v-4.5m0 4.5h4.5m-4.5 0L9 15M20.25 3.75h-4.5m4.5 0v4.5m0-4.5L15 9m5.25 11.25h-4.5m4.5 0v-4.5m0 4.5L15 15" /></svg>
                    </button>
                    <button id="btn-download-excel" class="icon-button" title="{{ get_text(lang, 'download_button').replace('JSON', 'Excel') }}">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg>
                    </button>
                </div>
                
                <div id="results-table" class="table-container-flotante">
                    </div>
            </div>
        </div>

        <div id="view-container-grouped" class="content-card" style="display: none; flex-direction: column;">

            <div class="table-controls">
                <div id="active-filters-list-grouped" style="flex-grow: 1; display: flex; flex-wrap: wrap; gap: 0.5rem;">
                    </div>
                <button id="btn-clear-filters-grouped" class="btn-rojo-secundario" style="display: none;" title="(Hotkey: Delete)">{{ get_text(lang, 'clear_all_button') }}</button>
            </div>

            <div style="position: relative; flex-grow: 1; min-height: 0;">
                <div class="table-actions">
                    <button id="btn-fullscreen-grouped" class="icon-button" title="Pantalla Completa (Hotkey: G)">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3.75v4.5m0-4.5h4.5m-4.5 0L9 9M3.75 20.25v-4.5m0 4.5h4.5m-4.5 0L9 15M20.25 3.75h-4.5m4.5 0v4.5m0-4.5L15 9m5.25 11.25h-4.5m4.5 0v-4.5m0 4.5L15 15" /></svg>
                    </button>
                    <button id="btn-download-excel-grouped" class="icon-button" title="{{ get_text(lang, 'download_button').replace('JSON', 'Excel') }}">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg>
                    </button>
                </div>

                <div id="results-table-grouped" class="table-container-flotante">
                    </div>
            </div>
        </div>

    </main>
    
    <div id="modal-overlay" style="display: none;">

        <div id="login-modal" style="display: none; text-align: center; max-width: 400px;">
            <h3 style="margin-bottom: 0.5rem;">Bienvenido al Buscador</h3>
            <p style="color: #666; font-size: 0.9rem; margin-bottom: 1.5rem;">Por favor, identifícate para comenzar la sesión de auditoría.</p>
            
            <div class="modal-form-group">
                <label for="login-name">Nombre Completo</label>
                <input type="text" id="login-name" placeholder="Ej: Juan Pérez">
            </div>
            
            <div class="modal-form-group">
                <label for="login-role">Puesto / Rol</label>
                <input type="text" id="login-role" placeholder="Ej: Auditor Senior">
            </div>

            <button id="btn-login-start" class="btn-azul-secundario" style="width: 100%; margin-top: 1rem;">
                Iniciar Sesión
            </button>
        </div>
        
        <div id="bulk-edit-modal" style="display: none;">
            <h3>Editar Filas Seleccionadas</h3>
            <p id="bulk-edit-count">Vas a editar 0 filas.</p>
            
            <div class="modal-form-group">
                <label for="bulk-edit-column">Columna a Editar</label>
                <select id="bulk-edit-column">
                    <option value="">Seleccione una columna...</option>
                </select>
            </div>
            
            <div class="modal-form-group">
                <label for="bulk-edit-value">Nuevo Valor</label>
                <input type="text" id="bulk-edit-value" list="bulk-edit-value-list">
                <datalist id="bulk-edit-value-list"></datalist>
            </div>
            
            <div class="modal-buttons">
                <button id="btn-bulk-cancel" class="btn-rojo-secundario">Cancelar</button>
                <button id="btn-bulk-apply" class="btn-verde-secundario">Aplicar Cambios</button>
            </div>
        </div>

        <div id="manage-lists-modal" style="display: none;">
            <h3>Administrar Autocompletado</h3>
            
            <div class="modal-form-group">
                <label for="manage-list-column">Selecciona la Lista a Editar</label>
                <select id="manage-list-column">
                    <option value="">Seleccione una columna...</option>
                </select>
            </div>

            <div class="modal-form-group">
                <label>Valores Actuales (Solo lectura):</label>
                <div id="current-list-values" class="values-display-box">
                    <em>Selecciona una columna para ver sus valores...</em>
                </div>
            </div>
            
            <div class="modal-form-group">
                <label for="manage-list-input">Modificaciones</label>
                <span class="input-help-text">Escribe valores para <strong>AÑADIR</strong>. Para <strong>ELIMINAR</strong>, pon un guion (-) delante. Separa con comas.</span>
                <textarea id="manage-list-input" rows="3" placeholder="Ej: Nuevo Estado, -Estado Antiguo, Pendiente"></textarea>
            </div>
            
            <div class="modal-buttons">
                <button id="btn-manage-cancel" class="btn-rojo-secundario">Cancelar</button>
                <button id="btn-manage-save" class="btn-verde-secundario">Guardar Lista</button>
            </div>
        </div>

        <div id="priority-rules-modal" style="display: none;">
            <h3>Configurar Reglas de Prioridad</h3>
            
            <div style="background-color: #fff; padding: 1rem; border-bottom: 1px solid #eee; margin-bottom: 1rem;">
                <h4 style="margin-top: 0; color: #2d3748; font-size: 1rem; margin-bottom: 0.5rem;">Configuración Global</h4>
                
                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                    <label style="display: flex; align-items: center; cursor: pointer; font-size: 0.9rem;">
                        <input type="checkbox" id="setting-scf" style="width: auto; margin-right: 10px;">
                        Priorizar automáticamente SCF e Intercompany (Como Alta)
                    </LAbel>
                    
                    <label style="display: flex; align-items: center; cursor: pointer; font-size: 0.9rem;">
                        <input type="checkbox" id="setting-age-sort" style="width: auto; margin-right: 10px;">
                        Ordenar automáticamente por Antigüedad (Más viejas primero)
                    </LAbel>
                </div>
                <div style="text-align: right; margin-top: 0.5rem;">
                    <button id="btn-save-settings" class="btn-small-link" style="padding: 0.4rem 1rem; width: auto;">Actualizar Configuración</button>
                </div>
            </div>

            <div style="background-color: #f9fafb; padding: 1rem; border-radius: 8px; border: 1px solid #e2e8f0; margin-bottom: 1.5rem;">
                <h4 style="margin-top: 0; margin-bottom: 1rem; font-size: 1rem; color: #2d3748;">Añadir Nueva Regla</h4>
                
                <div class="modal-form-group">
                    <label for="rule-column">Si la columna...</label>
                    <select id="rule-column">
                        <option value="">Seleccione una columna...</option>
                    </select>
                </div>

                <div class="modal-form-group" style="margin-top: 0.5rem;">
                    <label for="rule-operator">Condición:</label>
                    <select id="rule-operator">
                        <option value="equals">Es igual a (=)</option>
                        <option value="contains">Contiene</option>
                        <option value="greater">Mayor que (>)</option>
                        <option value="less">Menor que (<)</option>
                    </select>
                </div>
                <div class="modal-form-group" style="margin-top: 0.5rem;">
                    <label for="rule-value">Valor:</label> ```
                    
                </div>
                
                <div style="display: flex; gap: 1rem; margin-top: 0.5rem;">
                    <div class="modal-form-group" style="flex: 1;">
                        <label for="rule-priority">Asignar Prioridad:</label>
                        <select id="rule-priority">
                            <option value="Alta">Alta</option>
                            <option value="Media" selected>Media</option>
                            <option value="Baja">Baja</option>
                        </select>
                    </div>
                </div>

                <div class="modal-form-group" style="margin-top: 0.5rem;">
                    <label for="rule-reason">Razón (Aparecerá en el Tooltip):</label>
                    <input type="text" id="rule-reason" placeholder="Ej: Volumen alto por cierre de mes">
                </div>

                <div style="text-align: right; margin-top: 1rem;">
                    <button id="btn-add-rule" class="btn-verde-secundario" style="width: 100%;">Guardar Regla</button>
                </div>
            </div>

            <div>
                <h4 style="margin-top: 0; margin-bottom: 0.5rem; font-size: 1rem; color: #2d3748;">Reglas Activas</h4>
                <div id="rules-list-container" class="values-display-box" style="max-height: 150px;">
                    <em>Cargando reglas...</em>
                </div>
            </div>

            <div class="modal-buttons">
                <button id="btn-rules-close" class="btn-rojo-secundario">Cerrar</button>
            </div>
        </div>
        
       <div id="find-replace-modal" class="modal">
    <div class="modal-content" style="max-width: 600px; max-height: 85vh; overflow-y: auto;">
        
        <h3 style="margin-bottom: 1rem; color: #2c3e50;">Buscar y Reemplazar Avanzado</h3>

        <div style="background-color: #f8fafc; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0; margin-bottom: 20px;">
            <h4 style="margin-top:0; font-size:0.95rem; color:#4a5568; margin-bottom: 10px;">
                <i class="fas fa-filter"></i> Paso 1: Define a qué facturas aplicar (Filtros)
            </h4>
            
            <div style="display: flex; gap: 8px; margin-bottom: 10px;">
                <select id="fr-filter-column" class="form-select" style="flex: 2;">
                    </select>
                <select id="fr-filter-operator" class="form-select" style="flex: 1;">
                    <option value="contains">Contiene</option>
                    <option value="equals">Igual a (=)</option>
                    <option value="not_equals">Diferente (!=)</option>
                </select>
                <input type="text" id="fr-filter-value" class="form-input" placeholder="Valor..." list="fr-filter-datalist" style="flex: 2;">
                <datalist id="fr-filter-datalist"></datalist>
                
                <button id="btn-fr-add-filter" class="btn-azul-secundario" style="padding: 0 15px;">
                    <i class="fas fa-plus"></i>
                </button>
            </div>

            <div id="fr-active-filters" style="display: flex; flex-wrap: wrap; gap: 5px; min-height: 30px; align-items: center;">
                </div>
        </div>

        <div style="padding: 10px 5px;">
            <h4 style="margin-top:0; font-size:0.95rem; color:#4a5568; margin-bottom: 10px;">
                <i class="fas fa-edit"></i> Paso 2: Define el cambio
            </h4>

            <div class="modal-form-group">
                <label for="find-replace-column">En la columna:</label>
                <select id="find-replace-column" class="form-select" style="width: 100%;">
                    </select>
            </div>

            <div style="display: flex; gap: 15px;">
                <div class="modal-form-group" style="flex: 1;">
                    <label for="find-replace-find-text">Buscar texto:</label>
                    <input type="text" id="find-replace-find-text" class="form-input" placeholder="Ej: S.A.">
                </div>
                <div class="modal-form-group" style="flex: 1;">
                    <label for="find-replace-replace-text">Reemplazar con:</label>
                    <input type="text" id="find-replace-replace-text" class="form-input" placeholder="Ej: Inc.">
                </div>
            </div>
        </div>

        <div class="modal-buttons" style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px; text-align: right;">
            <button id="btn-find-replace-cancel" class="btn-rojo-secundario">Cancelar</button>
            <button id="btn-find-replace-apply" class="btn-verde-secundario">
                <i class="fas fa-check"></i> Aplicar Reemplazo
            </button>
        </div>
        
    </div>
</div>

        <div id="duplicates-modal" style="display: none;"></div>

    </div>

    <script>
        var SESSION_DATA = {{ session_data | tojson }};
    </script>

    <script type="text/javascript" src="https://unpkg.com/tabulator-tables@5.6.1/dist/js/tabulator.min.js"></script>
    <script src="{{ url_for('static', filename='script.js') }}"></script> 
</body>
</html>